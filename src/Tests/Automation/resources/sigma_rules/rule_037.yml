# Fieldref automation test - CHMOD with 3 string and 3 numeric fieldrefs
#
# String fieldrefs (endswith/startswith - NOT exactmatch):
#   1. process.file.path endswith process.file.filename  ("/usr/bin/chmod" ends with "chmod")
#   2. process.cmd startswith process.file.path           ("/usr/bin/chmod 755 ..." starts with "/usr/bin/chmod")
#   3. target.file.path endswith target.file.filename     ("/tmp/fieldref_chmod_test" ends with "fieldref_chmod_test")
#
# Numeric fieldrefs (gt/lte/equal - each match is due to the modifier, not incidental equality):
#   1. chmod.requested_mode gt target.file.mode           (493 > 420, strictly greater)
#   2. target.file.owner.uid lte chmod.requested_mode     (0 < 493, lte triggered by lt not equality)
#   3. target.file.owner.gid == target.file.owner.uid     (0 == 0, exact equality comparison)

id: 37
description: "Fieldref automation test - CHMOD with 3 string and 3 numeric fieldrefs"
action: "BLOCK_EVENT"
events:
    - CHMOD
detection:
    string_sel:
        process.file.path|endswith|fieldref: process.file.filename
        process.cmd|startswith|fieldref: process.file.path
        target.file.path|endswith|fieldref: target.file.filename
    numeric_sel:
        chmod.requested_mode|gt|fieldref: target.file.mode
        target.file.owner.uid|lte|fieldref: chmod.requested_mode
        target.file.owner.gid|fieldref: target.file.owner.uid
    target_file:
        target.file.path: /tmp/fieldref_chmod_test
    condition: string_sel and numeric_sel and target_file
