# Complex ~120 token CHMOD rule for testing near the new MAX_TOKENS_PER_RULE (128) limit.
# Match: /usr/bin/chmod 755 /tmp/complex_120_test
# No-match (due to not filter_bad): /usr/bin/chmod 755 /tmp/complex_120_excluded
# Uses: contains, startswith, endswith, exact match, numeric gte/lte,
#       contains|all, multiple sections, and/or/not operators, parentheses

id: 36
description: "Complex ~120-token chmod rule for max token limit testing"
action: "BLOCK_EVENT"
events:
    - CHMOD
detection:
    # 12 alternatives (OR) → 12 PRED + 11 OR = 23 tokens
    sel_path:
        - process.file.path|contains: "/usr"
        - process.file.path|contains: "/bin"
        - process.file.path|contains: "chmod"
        - process.file.path|startswith: "/usr/"
        - process.file.path|startswith: "/usr/bin"
        - process.file.path|endswith: "chmod"
        - process.file.path|endswith: "/chmod"
        - process.file.path|contains: "usr/bin"
        - process.file.path|contains: "bin/ch"
        - process.file.path|contains: "r/b"
        - process.file.path|contains: "hmo"
        - process.file.path: "/usr/bin/chmod"

    # 8 alternatives (OR) → 8 PRED + 7 OR = 15 tokens
    sel_name:
        - process.file.filename: "chmod"
        - process.file.filename|contains: "chm"
        - process.file.filename|contains: "mod"
        - process.file.filename|contains: "hmo"
        - process.file.filename|startswith: "ch"
        - process.file.filename|endswith: "od"
        - process.file.filename|contains: "c"
        - process.file.filename|contains: "h"

    # 10 alternatives (OR) → 10 PRED + 9 OR = 19 tokens
    sel_cmd:
        - process.cmd|contains: "chmod"
        - process.cmd|contains: "755"
        - process.cmd|contains: "/tmp"
        - process.cmd|contains: "complex"
        - process.cmd|contains: "120"
        - process.cmd|contains: " "
        - process.cmd|contains: "ch"
        - process.cmd|contains: "75"
        - process.cmd|contains: "mp"
        - process.cmd|contains: "test"

    # 3 fields (AND) → 3 PRED + 2 AND = 5 tokens
    sel_mode:
        chmod.requested_mode|gte: 400
        chmod.requested_mode|lte: 511
        chmod.requested_mode: 493

    # 8 alternatives (OR) → 8 PRED + 7 OR = 15 tokens
    sel_target:
        - target.file.path|contains: "/tmp"
        - target.file.path|contains: "complex"
        - target.file.path|startswith: "/tmp/"
        - target.file.path|contains: "120"
        - target.file.path|contains: "test"
        - target.file.path|contains: "mp/"
        - target.file.path|contains: "plex"
        - target.file.path|contains: "lex_"

    # 6 alternatives (OR) → 6 PRED + 5 OR = 11 tokens
    sel_process:
        - process.euid: 0
        - process.ruid: 0
        - process.egid: 0
        - process.rgid: 0
        - process.suid: 0
        - process.pid|gt: 1

    # contains|all with 4 values (AND) → 4 PRED + 3 AND = 7 tokens
    sel_cmd_all:
        process.cmd|contains|all:
            - "chmod"
            - "755"
            - "/tmp"
            - "120"

    # 5 alternatives (OR) → 5 PRED + 4 OR = 9 tokens
    filter_bad:
        - target.file.path|contains: "excluded"
        - target.file.path|contains: "forbidden"
        - target.file.path|contains: "ignore_it"
        - target.file.path|contains: "skip_this"
        - target.file.path|contains: "bypass_me"

    # 4 alternatives (OR) → 4 PRED + 3 OR = 7 tokens
    filter_no_match:
        - process.file.filename|contains: "malware"
        - process.file.filename|contains: "virus"
        - process.file.filename|contains: "trojan"
        - process.file.filename|contains: "hacktool"

    # Combining: 2 OR + 5 AND + 2 NOT = 9 tokens
    # Total: 23 + 15 + 19 + 5 + 15 + 11 + 7 + 9 + 7 + 9 = 120 tokens
    condition: (sel_path or sel_name) and sel_cmd and sel_mode and (sel_target or sel_process) and sel_cmd_all and not filter_bad and not filter_no_match
