# Complex exec rule - demonstrates: not, and, or, parentheses, 1 of, 3 of
# Match: /bin/echo complex_exec_test
# No-match (due to not): /bin/echo complex_exec_excluded
# (If "not filter_excluded" is removed, the excluded command would also match)

id: 2
description: "Complex exec rule with 1 of, 3 of, and, or, not conditions"
action: "BLOCK_EVENT"
events:
    - EXEC
detection:
    ind_echo:
        target.process.file.path|contains: "echo"

    ind_bin:
        target.process.file.path|startswith: "/bin"

    ind_cmd_all:
        target.process.cmd|contains|all:
            - "complex"
            - "test"

    ind_exec:
        target.process.cmd|contains: "exec"

    proc_python:
        process.file.path|contains: "python"

    proc_pytest:
        process.cmd|contains: "pytest"

    alt_direct:
        target.process.cmd|endswith: "test"

    filter_excluded:
        - target.process.cmd|contains: "excluded"

    condition: ((3 of ind_*) or alt_direct) and (1 of proc_*) and not filter_excluded
