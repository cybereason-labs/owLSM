# Complex chmod rule - demonstrates: not, and, or, parentheses, all of, lists, dicts, modifiers
# Match: /usr/bin/chmod 755 /tmp/complex_test
# No-match (due to not): /usr/bin/chmod 755 /tmp/complex_excluded
# (If the "not filter_excluded" is removed, the excluded command would also match)

id: 1
description: "Complex chmod rule with all major condition features"
action: "BLOCK_EVENT"
events:
    - CHMOD
detection:
    target_process:
        process.pid|gt: 100
        process.euid|gt: 999
        process.file.path|endswith: "chmod"

    target_cmd:
        process.cmd|contains|all:
            - "755"
            - "complex"

    target_parent:
        parent_process.file.path|contains: "python"
        parent_process.euid: 0
        parent_process.cmd|contains: "bin"

    target_file:
        target.file.path|startswith: "/tmp/"
        target.file.filename|contains: "complex"

    target_chmod:
        chmod.requested_mode|gte: 400
        chmod.requested_mode|lte: 511

    alt_mode:
        chmod.requested_mode: 493

    filter_excluded:
        - target.file.path|contains: "excluded"

    condition: ((all of target_*) or (target_process and alt_mode)) and not filter_excluded
