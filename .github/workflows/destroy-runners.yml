name: Destroy Runners

# =============================================================================
# Destroys OCI runner VMs via Terraform and deregisters offline runners
# from GitHub. Designed to be triggered manually or called by other workflows
# for cleanup after automation tests.
#
# OCI credentials are pre-baked in the runner image at /home/ghrunner/.oci/
# (config file + private API key). Terraform uses them automatically.
# =============================================================================

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  workflow_call:
    secrets:
      GH_RUNNER_PAT:
        required: true
      SSH_PUBLIC_KEY:
        required: true

env:
  TF_VAR_github_pat: ${{ secrets.GH_RUNNER_PAT }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_github_repo_url: ${{ github.server_url }}/${{ github.repository }}
  TF_VAR_run_id: ${{ github.run_id }}
  TF_WORKING_DIR: terraform

jobs:
  destroy-runners:
    name: Destroy OCI Runner VMs
    runs-on: ["OCI", "owLSM"]

    steps:
      # =====================================================================
      # Setup
      # =====================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"
          terraform_wrapper: false

      # =====================================================================
      # Terraform Init & Destroy
      # =====================================================================
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform destroy -auto-approve

      # =====================================================================
      # Deregister offline runners from GitHub
      # =====================================================================
      - name: Deregister offline runners from GitHub
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_PAT }}
        run: |
          ${{ env.TF_WORKING_DIR }}/scripts/deregister-runners.sh \
            "${{ github.repository }}" \
            "owLSM-automation"

      # =====================================================================
      # Summary
      # =====================================================================
      - name: Summary
        if: always()
        run: |
          echo "## Destroy Runners Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Destroy runners and deregister from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup workspace
        if: always()
        run: |
          cd ${{ github.workspace }}
          sudo git clean -ffdx
          echo "==> Cleanup completed!"
