name: Prepare Runners

# =============================================================================
# Provisions OCI compute instances from custom images and registers them
# as self-hosted GitHub Actions runners using Terraform.
# Designed to be called before the Automation Tests workflow.
#
# OCI credentials are pre-baked in the runner image at /home/ghrunner/.oci/
# (config file + private API key). Terraform uses them automatically.
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      destroy_only:
        description: "Only destroy existing runners (skip creation)"
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      destroy_only:
        description: "Only destroy existing runners (skip creation)"
        required: false
        default: false
        type: boolean
    secrets:
      GH_RUNNER_PAT:
        required: true
      SSH_PUBLIC_KEY:
        required: true
    outputs:
      runners_ready:
        description: "Whether runners were successfully provisioned"
        value: ${{ jobs.provision-runners.outputs.runners_ready }}

env:
  TF_VAR_github_pat: ${{ secrets.GH_RUNNER_PAT }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_github_repo_url: ${{ github.server_url }}/${{ github.repository }}
  TF_VAR_run_id: ${{ github.run_id }}
  TF_WORKING_DIR: terraform

jobs:
  provision-runners:
    name: Provision OCI Runner VMs
    runs-on: ["OCI", "owLSM"]
    outputs:
      runners_ready: ${{ steps.apply.outputs.runners_ready }}

    steps:
      # =====================================================================
      # Setup
      # =====================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate expected runner count
        id: runner_count
        run: |
          COUNT=$(jq '.runners | length' ${{ env.TF_WORKING_DIR }}/runners.auto.tfvars.json)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Expected runners: $COUNT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"
          terraform_wrapper: false

      # =====================================================================
      # Terraform Init
      # =====================================================================
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # =====================================================================
      # Destroy (if requested)
      # =====================================================================
      - name: Terraform Destroy (cleanup existing)
        if: inputs.destroy_only == true
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform destroy -auto-approve
          echo "runners_ready=false" >> $GITHUB_OUTPUT

      # =====================================================================
      # Plan & Apply
      # =====================================================================
      - name: Terraform Plan
        if: inputs.destroy_only != true
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: apply
        if: inputs.destroy_only != true
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve tfplan
          echo "runners_ready=true" >> $GITHUB_OUTPUT

      # =====================================================================
      # Wait for Runners to Register
      # =====================================================================
      - name: Wait for runners to become available
        if: inputs.destroy_only != true && steps.apply.outputs.runners_ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_PAT }}
        run: |
          ${{ env.TF_WORKING_DIR }}/scripts/wait-for-runners.sh \
            "${{ github.repository }}" \
            "run-${{ github.run_id }}" \
            "${{ steps.runner_count.outputs.count }}"

      # =====================================================================
      # Summary
      # =====================================================================
      - name: Summary
        if: always()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "## Prepare Runners Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.destroy_only }}" == "true" ]; then
            echo "**Action:** Destroy only" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Action:** Provision runners" >> $GITHUB_STEP_SUMMARY

            # Try to get IPs from Terraform output
            if terraform output -json runner_public_ips 2>/dev/null; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Runner IPs" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              terraform output -json runner_public_ips >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup workspace
        if: always()
        run: |
          cd ${{ github.workspace }}
          sudo git clean -ffdx
          echo "==> Cleanup completed!"
