name: Automation Tests Runners

# =============================================================================
# Provisions OCI compute instances from custom images and registers them
# as self-hosted GitHub Actions runners using Terraform.
# Designed to be called before the Automation Tests workflow.
#
# OCI credentials are pre-baked in the runner image at /home/ghrunner/.oci/
# (config file + private API key). Terraform uses them automatically.
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      artifact-name:
        description: "Name of the build artifact to download for automation tests"
        required: true
        type: string
      destroy_runners:
        description: 'Destroy ephemeral runner VMs for automation tests'
        type: boolean
        default: true
      automation-tests-command-args:
        description: "Command to run automation tests"
        required: true
        type: string
        default: "features/ --junitxml=$AUTOMATION_ROOT_DIR/results.xml -v -s"
  workflow_call:
    inputs:
      artifact-name:
        description: "Name of the build artifact to download for automation tests"
        required: true
        type: string
    secrets:
      GH_RUNNER_PAT:
        required: true
      SSH_PUBLIC_KEY:
        required: true
    outputs:
      runners_ready:
        description: "Whether runners were successfully provisioned"
        value: ${{ jobs.provision-runners.outputs.runners_ready }}

env:
  TF_VAR_github_pat: ${{ secrets.GH_RUNNER_PAT }}
  TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_github_repo_url: ${{ github.server_url }}/${{ github.repository }}
  TF_VAR_run_id: ${{ github.run_id }}
  TF_WORKING_DIR: terraform

jobs:
  provision-runners:
    name: Provision OCI Runner VMs
    runs-on: ["OCI", "owLSM"]
    outputs:
      runners_ready: ${{ steps.apply.outputs.runners_ready }}
      runner_labels: ${{ steps.runner_count.outputs.labels }}

    steps:
      # =====================================================================
      # Setup
      # =====================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate expected runner count and labels
        id: runner_count
        run: |
          TFVARS="${{ env.TF_WORKING_DIR }}/runners.auto.tfvars.json"
          COUNT=$(jq '.runners | length' "$TFVARS")
          LABELS=$(jq -c '[.runners[].display_name]' "$TFVARS")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "Expected runners: $COUNT"
          echo "Runner labels: $LABELS"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"
          terraform_wrapper: false

      # =====================================================================
      # Terraform Init
      # =====================================================================
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # =====================================================================
      # Plan & Apply
      # =====================================================================
      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve tfplan
          echo "runners_ready=true" >> $GITHUB_OUTPUT

      # =====================================================================
      # Wait for Runners to Register
      # =====================================================================
      - name: Wait for runners to become available
        if: steps.apply.outputs.runners_ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_PAT }}
        run: |
          ${{ env.TF_WORKING_DIR }}/scripts/wait-for-runners.sh \
            "${{ github.repository }}" \
            "run-${{ github.run_id }}" \
            "${{ steps.runner_count.outputs.count }}"

      # =====================================================================
      # Summary
      # =====================================================================
      - name: Summary
        if: always()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "## Prepare Runners Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** Provision runners" >> $GITHUB_STEP_SUMMARY

          # Try to get IPs from Terraform output
          if terraform output -json runner_public_ips 2>/dev/null; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Runner IPs" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            terraform output -json runner_public_ips >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup workspace
        if: always()
        run: |
          cd ${{ github.workspace }}
          sudo git clean -ffdx
          echo "==> Cleanup completed!"

  # =====================================================================
  # Run Automation Tests on Each Provisioned Runner (dynamic matrix)
  # =====================================================================
  # Matrix is generated from display_name values in
  # terraform/runners.auto.tfvars.json
  # =====================================================================

  run-automation-tests:
    name: "Automation Tests (${{ matrix.runner-label }})"
    needs: provision-runners
    if: needs.provision-runners.outputs.runners_ready == 'true'
    strategy:
      fail-fast: false
      matrix:
        runner-label: ${{ fromJSON(needs.provision-runners.outputs.runner_labels) }}
    uses: ./.github/workflows/automation-tests.yml
    with:
      runner-label: ${{ matrix.runner-label }}
      artifact-name: ${{ inputs.artifact-name }}
      automation-tests-command-args: ${{ inputs.automation-tests-command-args }}
    secrets:
      GH_RUNNER_PAT: ${{ secrets.GH_RUNNER_PAT }}

  # =====================================================================
  # Destroy Ephemeral Runners via Terraform
  # =====================================================================

  destroy-runners:
    name: Destroy OCI Runner VMs
    needs: [provision-runners, run-automation-tests]
    if: always() && inputs.destroy_runners == true
    uses: ./.github/workflows/destroy-runners.yml
    secrets:
      GH_RUNNER_PAT: ${{ secrets.GH_RUNNER_PAT }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
