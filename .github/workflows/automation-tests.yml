name: Automation Tests

# =============================================================================
# Runs automation tests on a specific self-hosted runner provisioned by
# the Prepare Runners workflow. Downloads the build artifact via GH API,
# extracts it to /opt, and executes the pytest automation suite.
#
# Designed to be called from prepare-runners.yml using matrix strategy.
# =============================================================================

on:
  workflow_call:
    inputs:
      runner-label:
        description: "Individual runner distro label (e.g., ubuntu-22)"
        required: true
        type: string
      artifact-name:
        description: "Name of the build artifact to download"
        required: true
        type: string
      automation-tests-command-args:
        description: "Command to run automation tests"
        required: true
        type: string
        default: "features/ --junitxml=$AUTOMATION_ROOT_DIR/results.xml -v -s"
    secrets:
      GH_RUNNER_PAT:
        required: true

env:
  AUTOMATION_ROOT_DIR: /opt/owLSM/src/Tests/Automation
  GH_VERSION: 2.87.0

jobs:
  automation-tests:
    name: "Run Tests (${{ inputs.runner-label }})"
    runs-on: ["run-${{ github.run_id }}", "${{ inputs.runner-label }}"]

    steps:
      # =====================================================================
      # Prerequisites
      # =====================================================================
      - name: Ensure GitHub CLI is installed
        run: |
          if command -v gh &>/dev/null; then
            echo "==> gh already installed: $(gh --version | head -1)"
          else
            echo "==> gh not found, installing..."
            wget -q "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz"
            tar -xzf gh_${GH_VERSION}_linux_amd64.tar.gz
            sudo mv gh_${GH_VERSION}_linux_amd64/bin/gh /usr/bin/gh
            rm -rf gh_*
            echo "==> gh installed: $(gh --version | head -1)"
          fi

      - name: Ensure uv is installed
        run: |
          if command -v uv &>/dev/null; then
            echo "==> uv already installed: $(uv --version)"
          else
            echo "==> uv not found, installing..."
            curl -Lf https://astral.sh/uv/install.sh | sudo env INSTALLER_NO_MODIFY_PATH=1 sh
            sudo mv /root/.local/bin/uv /usr/bin/uv
            sudo mv /root/.local/bin/uvx /usr/bin/uvx
            echo "==> uv installed: $(uv --version)"
          fi

      # =====================================================================
      # Download & Extract Artifact
      # =====================================================================
      - name: Download artifact via GH API
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_PAT }}
        run: |
          echo "==> Searching for latest artifact: ${{ inputs.artifact-name }}"

          # Sort by created_at and pick the most recent one
          ARTIFACT_ID=$(gh api "repos/${{ github.repository }}/actions/artifacts?name=${{ inputs.artifact-name }}" \
            --jq '[.artifacts[]] | sort_by(.created_at) | last | .id')

          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
            echo "ERROR: Artifact '${{ inputs.artifact-name }}' not found"
            exit 1
          fi

          echo "==> Artifact ID: $ARTIFACT_ID"
          gh api "repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" > "${{ inputs.artifact-name }}.zip"
          echo "==> Artifact downloaded successfully"
          ls -lh "${{ inputs.artifact-name }}.zip"

      - name: Extract artifact to /opt/owLSM
        run: |
          echo "==> Extracting artifact to /opt/owLSM"
          sudo mkdir -p /opt/owLSM

          # GH API wraps the artifact in a zip; extract to get the inner .tar.gz
          unzip -o "${{ inputs.artifact-name }}.zip" -d /tmp/artifact_download
          # Extract the tarball to /opt/owLSM
          sudo tar xzf /tmp/artifact_download/*.tar.gz -C /opt/owLSM
          rm -rf /tmp/artifact_download

          sudo chown -R "$(id -u):$(id -g)" /opt/owLSM
          echo "==> Artifact extracted to /opt/owLSM"
          ls -la /opt/owLSM/

      # =====================================================================
      # Install Test Dependencies
      # =====================================================================
      - name: Setup venv and install requirements
        run: |
          cd $AUTOMATION_ROOT_DIR
          uv venv venv --clear
          source venv/bin/activate
          uv pip install -r requirements.txt
          echo "==> venv ready: $(pytest --version)"

      # =====================================================================
      # Run Automation Tests
      # =====================================================================
      - name: Run automation tests
        run: |
          cd $AUTOMATION_ROOT_DIR
          sudo PYTHONPATH=$AUTOMATION_ROOT_DIR $AUTOMATION_ROOT_DIR/venv/bin/pytest ${{inputs.automation-tests-command-args}}

      # =====================================================================
      # Upload Results
      # =====================================================================
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-test-results-${{ inputs.runner-label }}
          path: ${{ env.AUTOMATION_ROOT_DIR }}/results.xml
          retention-days: 30
