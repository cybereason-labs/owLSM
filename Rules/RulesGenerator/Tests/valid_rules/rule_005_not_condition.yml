# Rule 005: Complex rule with 64 tokens - does NOT match due to strategic "not"
# Target: chmod 777 /tmp/1 (path=/usr/bin/chmod, filename=chmod, commandline="chmod 777 /tmp/1")
# The "not chmodMatch" at the end causes this rule to NOT match
# If you remove "and not chmodMatch", the rule WILL match
# Uses: contains, startswith, exact match, multiple sections, and/or/not operators
id: 5
description: "Complex 64-token rule that does NOT match chmod due to not operator"
action: "BLOCK_EVENT"
events:
    - CHMOD
detection:
    # Section 1: Path checks (matches /usr/bin/chmod)
    pathMatch:
        - process.file.path|contains: "/usr"
        - process.file.path|contains: "/bin"
        - process.file.path|contains: "chmod"
        - process.file.path|startswith: "/usr/"
        - process.file.path|startswith: "/usr/bin"
    
    # Section 2: Filename checks (matches chmod)
    filenameMatch:
        - process.file.filename: "chmod"
        - process.file.filename|contains: "chm"
        - process.file.filename|contains: "od"
    
    # Section 3: CommandLine checks (matches "chmod 777 /tmp/1")
    cmdlineMatch:
        - process.cmd|contains: "chmod"
        - process.cmd|contains: "777"
        - process.cmd|contains: "/tmp"
        - process.cmd|contains: "/tmp/1"
        - process.cmd|contains: " "
    
    # Section 4: More path patterns (all match)
    pathPatterns:
        - process.file.path|contains: "usr"
        - process.file.path|contains: "bin"
        - process.file.path|contains: "hmo"
        - process.file.path|contains: "mod"
    
    # Section 5: More commandline patterns (all match)
    cmdPatterns:
        - process.cmd|contains: "ch"
        - process.cmd|contains: "mo"
        - process.cmd|contains: "77"
        - process.cmd|contains: "tm"
        - process.cmd|contains: "mp"
    
    # Section 6: Things that don't match (for not exclusions)
    noPresent:
        - process.file.path|contains: "malware"
        - process.cmd|contains: "virus"
    
    # Section 7: Additional matches
    moreMatches:
        - process.file.path|contains: "/"
        - process.file.filename|contains: "c"
        - process.file.filename|contains: "h"
        - process.cmd|contains: "1"
    
    # Section 8: THE KEY SECTION - this MATCHES chmod, causing "not chmodMatch" to be FALSE
    # This is what makes the whole rule NOT match
    # REMOVE "and not chmodMatch" from condition to make rule match
    chmodMatch:
        - process.file.filename|contains: "chmod"
        - process.file.path|contains: "chmod"
        - process.cmd|contains: "chmod"

    # Condition: Everything matches EXCEPT the final "not chmodMatch" makes it false
    # Without "and not chmodMatch", this rule would match chmod 777 /tmp/1
    # With "and not chmodMatch", since chmodMatch IS true, not chmodMatch = false, whole rule = false
    condition: (pathMatch or filenameMatch) and cmdlineMatch and pathPatterns and cmdPatterns and not noPresent and moreMatches and not chmodMatch
