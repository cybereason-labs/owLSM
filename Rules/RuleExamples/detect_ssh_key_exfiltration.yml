# Detect SSH Key Exfiltration Attempt
# 
# This rule detects suspicious read access to SSH private keys by
# non-standard processes. SSH keys should typically only be read by
# the SSH client or SSH agent, not by curl, wget, or shell scripts.
#
# Real-world attack: Attackers often try to steal SSH keys for lateral
# movement within a network. This rule helps detect such attempts.

id: 100
description: "Detect unauthorized SSH private key access"
action: "BLOCK_EVENT"
events:
    - READ
detection:
    selection_ssh_keys:
        target.file.path|contains:
            - ".ssh/id_rsa"
            - ".ssh/id_ed25519"
            - ".ssh/id_ecdsa"
            - ".ssh/id_dsa"
    selection_suspicious_process:
        process.file.filename|endswith:
            - "curl"
            - "wget"
            - "nc"
            - "ncat"
            - "python"
            - "perl"
            - "ruby"
    filter_authorized:
        process.file.path|startswith:
            - "/usr/bin/ssh"
            - "/usr/bin/ssh-agent"
            - "/usr/bin/scp"
            - "/usr/bin/sftp"
    condition: selection_ssh_keys and selection_suspicious_process and not filter_authorized

